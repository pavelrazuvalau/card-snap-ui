#!/bin/bash

# ============================================================================
# Pre-commit Hook for Card Snap UI
# ============================================================================
# Validates:
# 1. Code formatting (dart format)
# 2. Branch naming (feature/, bugfix/, release/, hotfix/)
# 3. Commit message format (Conventional Commits)
# ============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get current branch name
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

# Get commit message (from COMMIT_MSG file or stdin)
COMMIT_MSG_FILE="$1"
if [ -n "$COMMIT_MSG_FILE" ]; then
  COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
else
  COMMIT_MSG=$(cat)
fi

ERRORS=0

echo -e "${GREEN}Running pre-commit checks...${NC}"

# ============================================================================
# 1. Check Branch Naming
# ============================================================================

echo -e "${YELLOW}Checking branch name: $BRANCH_NAME${NC}"

# Allowed branch patterns
ALLOWED_PATTERNS=(
  "^feature/"
  "^bugfix/"
  "^release/"
  "^hotfix/"
  "^main$"
  "^develop$"
)

BRANCH_VALID=false
for pattern in "${ALLOWED_PATTERNS[@]}"; do
  if echo "$BRANCH_NAME" | grep -qE "$pattern"; then
    BRANCH_VALID=true
    break
  fi
done

if [ "$BRANCH_VALID" = false ]; then
  echo -e "${RED}❌ Invalid branch name: $BRANCH_NAME${NC}"
  echo -e "${YELLOW}Branch must match one of:${NC}"
  echo -e "  - feature/*"
  echo -e "  - bugfix/*"
  echo -e "  - release/*"
  echo -e "  - hotfix/*"
  echo -e "  - main"
  echo -e "  - develop"
  ERRORS=$((ERRORS + 1))
else
  echo -e "${GREEN}✓ Branch name is valid${NC}"
fi

# ============================================================================
# 2. Check Code Formatting
# ============================================================================

echo -e "${YELLOW}Checking code formatting...${NC}"

# Check if there are any Dart files to format
DART_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.dart$' || true)

if [ -n "$DART_FILES" ]; then
  # Check if dart is available
  if ! command -v dart &> /dev/null; then
    echo -e "${YELLOW}⚠ dart command not found, skipping formatting check${NC}"
    echo -e "${YELLOW}  Install Flutter SDK to enable formatting checks${NC}"
  else
    # Get list of staged Dart files
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.dart$' || true)
    
    if [ -n "$STAGED_FILES" ]; then
      # Check formatting by comparing formatted vs staged
      FORMAT_ERROR=false
      UNFORMATTED_FILES=()
      
      for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
          # Create temporary copy and format it
          TEMP_FILE=$(mktemp)
          cp "$file" "$TEMP_FILE"
          dart format "$TEMP_FILE" > /dev/null 2>&1
          
          # Compare formatted version with original
          if ! diff -q "$file" "$TEMP_FILE" > /dev/null 2>&1; then
            FORMAT_ERROR=true
            UNFORMATTED_FILES+=("$file")
          fi
          
          rm -f "$TEMP_FILE"
        fi
      done
      
      if [ "$FORMAT_ERROR" = true ]; then
        echo -e "${RED}❌ Code formatting check failed${NC}"
        echo -e "${YELLOW}The following files need formatting:${NC}"
        for file in "${UNFORMATTED_FILES[@]}"; do
          echo -e "  - $file"
        done
        echo -e "${YELLOW}Run: dart format .${NC}"
        echo -e "${YELLOW}Then stage the changes and commit again${NC}"
        ERRORS=$((ERRORS + 1))
      else
        echo -e "${GREEN}✓ Code formatting is valid${NC}"
      fi
    fi
  fi
else
  echo -e "${GREEN}✓ No Dart files to check${NC}"
fi

# ============================================================================
# 3. Check Commit Message Format (Conventional Commits)
# ============================================================================

echo -e "${YELLOW}Checking commit message format...${NC}"

# Remove leading/trailing whitespace and get first line
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

# Conventional Commits pattern: type(scope): description
# Types: feat, fix, docs, style, refactor, test, chore
CONVENTIONAL_PATTERN='^(feat|fix|docs|style|refactor|test|chore)(\([^)]+\))?: .+$'

if echo "$FIRST_LINE" | grep -qE "$CONVENTIONAL_PATTERN"; then
  echo -e "${GREEN}✓ Commit message follows Conventional Commits format${NC}"
else
  echo -e "${RED}❌ Invalid commit message format${NC}"
  echo -e "${YELLOW}Commit message must follow Conventional Commits:${NC}"
  echo -e "  Format: \`type(scope): description\`"
  echo -e "  Types: feat, fix, docs, style, refactor, test, chore"
  echo -e "  Examples:"
  echo -e "    feat(auth): add token refresh on login"
  echo -e "    fix(devices): prevent crash when device id is null"
  echo -e "    docs(domain): explain device sync use case"
  echo -e "    refactor(ui): simplify dashboard rebuild logic"
  echo -e ""
  echo -e "${YELLOW}Your message:${NC} $FIRST_LINE"
  ERRORS=$((ERRORS + 1))
fi

# ============================================================================
# Summary
# ============================================================================

if [ $ERRORS -eq 0 ]; then
  echo -e "${GREEN}✓ All pre-commit checks passed${NC}"
  exit 0
else
  echo -e "${RED}❌ Pre-commit checks failed ($ERRORS error(s))${NC}"
  echo -e "${YELLOW}Please fix the errors above before committing${NC}"
  exit 1
fi

