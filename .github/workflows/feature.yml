name: Feature/Bugfix Branch CI

on:
  # Automatic checks on push to feature and bugfix branches
  push:
    branches:
      - 'feature/**'
      - 'bugfix/**'
  
  # Manual build trigger for feature and bugfix branches
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name (e.g., feature/add-card-scanning or bugfix/fix-crash)'
        required: true
        type: string
        default: ${{ github.ref_name }}

jobs:
  # Job for automatic push triggers - only checks (feature and bugfix branches)
  checks:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Verify formatting
        run: dart format --set-exit-if-changed .

      - name: Run analyzer
        run: flutter analyze

      - name: Run tests with coverage
        run: flutter test --coverage

      - name: Check coverage thresholds
        run: |
          echo "Coverage thresholds:"
          echo "  Domain: 90%+"
          echo "  Data: 80%+"
          echo "  Presentation: 70%+"
          echo "  Core: 85%+"
          echo ""
          echo "Review coverage/lcov.info to ensure thresholds are met"

  # Job for manual workflow_dispatch - checks + Android build (feature and bugfix branches)
  build:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_name }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Verify formatting
        run: dart format --set-exit-if-changed .

      - name: Run analyzer
        run: flutter analyze

      - name: Run tests with coverage
        run: flutter test --coverage

      - name: Check coverage thresholds
        run: |
          echo "Coverage thresholds:"
          echo "  Domain: 90%+"
          echo "  Data: 80%+"
          echo "  Presentation: 70%+"
          echo "  Core: 85%+"
          echo ""
          echo "Review coverage/lcov.info to ensure thresholds are met"

      # Auto-determine build parameters
      - name: Set build date
        id: build_date
        run: |
          BUILD_DATE=$(date +%Y-%m-%d)
          echo "date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "Build date: $BUILD_DATE"

      - name: Get build number
        id: build_number
        run: |
          BRANCH_NAME="${{ inputs.branch_name }}"
          BUILD_DATE="${{ steps.build_date.outputs.date }}"
          
          # Use script to get next build number
          BUILD_NUM=$(bash .github/scripts/get-build-number.sh "$BRANCH_NAME" "$BUILD_DATE")
          echo "number=$BUILD_NUM" >> $GITHUB_OUTPUT
          echo "Build number: $BUILD_NUM"

      - name: Build Android APK
        run: |
          flutter build apk --release

      - name: Build Android App Bundle
        run: |
          flutter build appbundle --release

      - name: Prepare artifact names
        id: artifacts
        run: |
          BRANCH_SAFE=$(echo "${{ inputs.branch_name }}" | sed 's/\//-/g')
          BUILD_DATE="${{ steps.build_date.outputs.date }}"
          BUILD_NUM="${{ steps.build_number.outputs.number }}"
          
          APK_NAME="app-${BRANCH_SAFE}-${BUILD_DATE}-${BUILD_NUM}.apk"
          AAB_NAME="app-${BRANCH_SAFE}-${BUILD_DATE}-${BUILD_NUM}.aab"
          
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "aab_name=$AAB_NAME" >> $GITHUB_OUTPUT
          echo "Artifact names:"
          echo "  APK: $APK_NAME"
          echo "  AAB: $AAB_NAME"

      - name: Rename Android APK
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk "build/app/outputs/flutter-apk/${{ steps.artifacts.outputs.apk_name }}"

      - name: Rename Android AAB
        run: |
          mv build/app/outputs/bundle/release/app-release.aab "build/app/outputs/bundle/release/${{ steps.artifacts.outputs.aab_name }}"

      # ============================================================================
      # iOS BUILD (DISABLED - Requires Apple Developer Program)
      # ============================================================================
      # To enable iOS builds:
      # 1. Subscribe to Apple Developer Program ($99/year)
      # 2. Create certificates and provisioning profiles
      # 3. Store them in GitHub Secrets:
      #    - APPLE_DEVELOPER_CERTIFICATE_BASE64
      #    - APPLE_DEVELOPER_CERTIFICATE_PASSWORD
      #    - APPLE_PROVISIONING_PROFILE_BASE64
      #    - APPLE_APP_ID
      # 4. Uncomment the steps below and switch to macOS runner
      # 5. Add: runs-on: macos-latest
      # 
      # Documentation: https://docs.flutter.dev/deployment/ios
      # ============================================================================
      #
      # - name: Setup iOS Build
      #   uses: maxim-lobanov/setup-xcode@v1
      #   with:
      #     xcode-version: latest-stable
      #
      # - name: Build iOS IPA
      #   run: |
      #     flutter build ipa --release
      #
      # - name: Rename iOS IPA
      #   run: |
      #     BRANCH_SAFE=$(echo "${{ inputs.branch_name }}" | sed 's/\//-/g')
      #     BUILD_DATE="${{ steps.build_date.outputs.date }}"
      #     BUILD_NUM="${{ steps.build_number.outputs.number }}"
      #     IPA_NAME="app-${BRANCH_SAFE}-${BUILD_DATE}-${BUILD_NUM}.ipa"
      #     mv build/ios/ipa/*.ipa "build/ios/ipa/$IPA_NAME"

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/${{ steps.artifacts.outputs.apk_name }}
          retention-days: 7

      - name: Upload Android AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/${{ steps.artifacts.outputs.aab_name }}
          retention-days: 7

      # - name: Upload iOS IPA
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: ios-ipa
      #     path: build/ios/ipa/${{ steps.artifacts.outputs.ipa_name }}
      #     retention-days: 7

      - name: Build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ inputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Date:** ${{ steps.build_date.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number:** ${{ steps.build_number.outputs.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **APK:** \`${{ steps.artifacts.outputs.apk_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **AAB:** \`${{ steps.artifacts.outputs.aab_name }}\`" >> $GITHUB_STEP_SUMMARY

